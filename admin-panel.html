<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="js/data.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
        <div class="flex items-center space-x-4">
            <h1 class="text-xl font-bold">Panel del Profesional</h1>
            <nav class="hidden md:flex space-x-4">
                <a href="#turnos" class="hover:text-blue-200">Turnos</a>
                <a href="#disponibilidad" class="hover:text-blue-200">Disponibilidad</a>
                <a href="#notas" class="hover:text-blue-200">Notas</a>
            </nav>
        </div>
        <div class="flex items-center space-x-4">
            <span class="hidden md:inline-block">
                <i class="fas fa-user-md mr-2"></i><span id="adminName"></span>
            </span>
            <button onclick="logout()" class="bg-white text-blue-600 px-4 py-2 rounded hover:bg-gray-100 flex items-center">
                <i class="fas fa-sign-out-alt mr-2"></i>Cerrar sesión
            </button>
        </div>
    </header>

    <main class="p-6 max-w-6xl mx-auto">
        <section id="turnos" class="mb-10">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Turnos programados</h2>
                <div class="flex space-x-2">
                    <button onclick="mostrarModalNuevoTurno()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        <i class="fas fa-plus mr-2"></i>Nuevo turno
                    </button>
                    <input type="date" id="filterDate" class="border rounded px-3 py-1">
                    <button onclick="filtrarTurnos()" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700">
                        <i class="fas fa-filter mr-2"></i>Filtrar
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto bg-white rounded-lg shadow">
                <table class="min-w-full text-left">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-4 py-3 text-sm font-semibold text-gray-600">Nombre</th>
                            <th class="px-4 py-3 text-sm font-semibold text-gray-600">Fecha</th>
                            <th class="px-4 py-3 text-sm font-semibold text-gray-600">Hora</th>
                            <th class="px-4 py-3 text-sm font-semibold text-gray-600">Motivo</th>
                            <th class="px-4 py-3 text-sm font-semibold text-gray-600">Teléfono</th>
                            <th class="px-4 py-3 text-sm font-semibold text-gray-600">Estado</th>
                            <th class="px-4 py-3 text-sm font-semibold text-gray-600">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="turnosTableBody" class="divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </section>

        <section id="pacientes" class="mb-10">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Pacientes</h2>
                <div class="flex space-x-2">
                    <input 
                        type="text" 
                        id="buscarPaciente" 
                        placeholder="Buscar por nombre o DNI..." 
                        class="border rounded px-3 py-2 w-64"
                        oninput="buscarPacientes()"
                    >
                    <button onclick="mostrarModalNuevoPaciente()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        <i class="fas fa-user-plus mr-2"></i>Nuevo paciente
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="pacientesGrid">
            </div>
        </section>

        <section id="disponibilidad" class="mb-10">
            <h2 class="text-2xl font-semibold mb-4">Disponibilidad</h2>
            <div class="bg-white p-6 rounded-lg shadow space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-lg font-medium mb-3">Horarios disponibles</h3>
                        <div class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <select id="diaSelect" class="border rounded px-3 py-2 w-full">
                                    <option value="1">Lunes</option>
                                    <option value="2">Martes</option>
                                    <option value="3">Miércoles</option>
                                    <option value="4">Jueves</option>
                                    <option value="5">Viernes</option>
                                </select>
                                <input type="time" id="horaInicio" min="08:00" max="20:00" value="08:00" class="border rounded px-3 py-2">
                                <input type="time" id="horaFin" min="08:00" max="20:00" value="20:00" class="border rounded px-3 py-2">
                            </div>
                            <div id="errorHorario" class="text-red-500 text-sm hidden">El horario debe estar entre las 8:00 y las 20:00</div>
                            <button onclick="agregarHorario()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">
                                <i class="fas fa-plus mr-2"></i>Agregar horario
                            </button>
                        </div>
                        <div id="horariosActuales" class="mt-4">
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium mb-3">Días no laborables</h3>
                        <div class="space-y-2">
                            <input type="date" id="diaNoLaborable" class="border rounded px-3 py-2 w-full">
                            <button onclick="marcarNoLaborable()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">
                                <i class="fas fa-calendar-times mr-2"></i>Marcar como no laborable
                            </button>
                            <div id="diasNoLaborables" class="mt-4">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="notas" class="mb-10">
            <h2 class="text-2xl font-semibold mb-4">Notas clínicas</h2>
            <div class="bg-white p-6 rounded-lg shadow space-y-4">
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="buscarPaciente" placeholder="Buscar paciente..." class="border rounded px-3 py-2 flex-1">
                    <button onclick="buscarNotas()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        <i class="fas fa-search mr-2"></i>Buscar
                    </button>
                </div>
                <div id="notasList" class="space-y-4">
                </div>
                <div class="space-y-4">
                    <textarea 
                        id="nuevaNota"
                        class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        placeholder="Escribe observaciones del paciente..." 
                        rows="5"
                    ></textarea>
                    <div class="flex justify-between items-center">
                        <div class="space-x-2">
                            <input type="file" id="adjuntoInput" class="hidden">
                            <button onclick="document.getElementById('adjuntoInput').click()" class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-300">
                                <i class="fas fa-paperclip mr-1"></i>Adjuntar
                            </button>
                            <span id="nombreArchivo" class="text-sm text-gray-500"></span>
                        </div>
                        <button onclick="guardarNota()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            <i class="fas fa-save mr-2"></i>Guardar nota
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                Dashboard Avanzado
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-4 rounded-lg text-white">
                    <h3 class="text-lg font-semibold mb-2">Tasa de Ocupación</h3>
                    <p class="text-3xl font-bold" id="tasaOcupacion">--%</p>
                    <p class="text-sm opacity-80">Promedio diario</p>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-600 p-4 rounded-lg text-white">
                    <h3 class="text-lg font-semibold mb-2">Eficiencia</h3>
                    <p class="text-3xl font-bold" id="eficienciaTotal">--%</p>
                    <p class="text-sm opacity-80">Tasa de completación</p>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-4 rounded-lg text-white">
                    <h3 class="text-lg font-semibold mb-2">Tiempo de Espera</h3>
                    <p class="text-3xl font-bold" id="tiempoEspera">-- días</p>
                    <p class="text-sm opacity-80">Promedio</p>
                </div>
                <div class="bg-gradient-to-br from-red-500 to-red-600 p-4 rounded-lg text-white">
                    <h3 class="text-lg font-semibold mb-2">Cancelaciones</h3>
                    <p class="text-3xl font-bold" id="tasaCancelacion">--%</p>
                    <p class="text-sm opacity-80">Último mes</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-4">Tendencias de Crecimiento</h3>
                    <canvas id="graficoCrecimiento" class="w-full"></canvas>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-4">Distribución Horaria</h3>
                    <canvas id="graficoDistribucion" class="w-full"></canvas>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-4">Distribución por Obra Social</h3>
                    <canvas id="graficoObrasSociales" class="w-full"></canvas>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-4">Predicción de Demanda</h3>
                    <canvas id="graficoPredicciones" class="w-full"></canvas>
                </div>
            </div>

            <div class="mt-8 bg-blue-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-lightbulb text-blue-600 mr-2"></i>
                    Recomendaciones Inteligentes
                </h3>
                <div id="recomendaciones" class="space-y-2">
                </div>
            </div>
        </div>
    </main>

    <div id="modalNuevoTurno" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-auto mt-20">
            <h3 class="text-xl font-semibold mb-4">Nuevo Turno</h3>
            <form id="formNuevoTurno" onsubmit="guardarNuevoTurno(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Paciente</label>
                    <select id="pacienteSelect" required class="w-full border rounded px-3 py-2">
                        <option value="">Seleccionar paciente...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                    <input type="date" id="fechaTurno" required class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Hora</label>
                    <input type="time" id="horaTurno" required class="w-full border rounded px-3 py-2" step="300">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Motivo</label>
                    <input type="text" id="motivoTurno" required class="w-full border rounded px-3 py-2">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="cerrarModalNuevoTurno()" class="px-4 py-2 border rounded text-gray-600 hover:bg-gray-100">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalNuevoPaciente" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-auto mt-20">
            <h3 class="text-xl font-semibold mb-4">Nuevo Paciente</h3>
            <form id="formNuevoPaciente" onsubmit="guardarNuevoPaciente(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre completo</label>
                    <input type="text" id="nombrePaciente" required class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">DNI</label>
                    <input type="text" id="dniPaciente" required class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                    <input type="tel" id="telefonoPaciente" required class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="emailPaciente" required class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Obra Social</label>
                    <select id="obraSocialPaciente" onchange="actualizarPlanes()" class="w-full border rounded px-3 py-2">
                        <option value="">Sin obra social</option>
                    </select>
                </div>
                <div id="planContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Plan</label>
                    <select id="planObraSocial" class="w-full border rounded px-3 py-2">
                        <option value="">Seleccionar plan...</option>
                    </select>
                </div>
                <div id="numeroSocioContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Número de Socio</label>
                    <input type="text" id="numeroSocio" class="w-full border rounded px-3 py-2">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="cerrarModalNuevoPaciente()" class="px-4 py-2 border rounded text-gray-600 hover:bg-gray-100">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalHistorial" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-auto mt-20">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Historial del Paciente</h3>
                <button onclick="cerrarModalHistorial()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="historialContent" class="space-y-4">
            </div>
        </div>
    </div>

    <div id="modalEditarPaciente" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-auto mt-20">
            <h3 class="text-xl font-semibold mb-4">Editar Paciente</h3>
            <form id="formEditarPaciente" onsubmit="guardarEdicionPaciente(event)" class="space-y-4">
                <input type="hidden" id="editPacienteId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre completo</label>
                    <input type="text" id="editNombrePaciente" required class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">DNI</label>
                    <input type="text" id="editDniPaciente" required class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                    <input type="tel" id="editTelefonoPaciente" required class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="editEmailPaciente" required class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Obra Social</label>
                    <select id="editObraSocialPaciente" onchange="actualizarPlanesEdicion()" class="w-full border rounded px-3 py-2">
                        <option value="">Sin obra social</option>
                    </select>
                </div>
                <div id="editPlanContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Plan</label>
                    <select id="editPlanObraSocial" class="w-full border rounded px-3 py-2">
                        <option value="">Seleccionar plan...</option>
                    </select>
                </div>
                <div id="editNumeroSocioContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Número de Socio</label>
                    <input type="text" id="editNumeroSocio" class="w-full border rounded px-3 py-2">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="cerrarModalEditarPaciente()" class="px-4 py-2 border rounded text-gray-600 hover:bg-gray-100">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Guardar cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem('auth') !== 'true') {
            window.location.href = 'admin-login.html';
        }
        document.getElementById('adminName').textContent = localStorage.getItem('adminName');

        document.getElementById('filterDate').valueAsDate = new Date();
        
        document.getElementById('horaTurno').setAttribute('min', '08:00');
        document.getElementById('horaTurno').setAttribute('max', '20:00');

        actualizarTablaTurnos();
        actualizarListaPacientes();
        cargarSelectPacientes();
        cargarObrasSociales();
        actualizarDashboard();
    });

    function actualizarTablaTurnos() {
        const tbody = document.getElementById('turnosTableBody');
        tbody.innerHTML = '';

        dbTurnos.forEach(turno => {
            const paciente = getPaciente(turno.pacienteId);
            if (!paciente) return;

            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `
                <td class="px-4 py-3">
                    <div class="flex items-center">
                        <img class="h-8 w-8 rounded-full mr-3" 
                            src="https://ui-avatars.com/api/?name=${encodeURIComponent(paciente.nombre)}" 
                            alt="${paciente.nombre}">
                        <span>${paciente.nombre}</span>
                    </div>
                </td>
                <td class="px-4 py-3">${turno.fecha}</td>
                <td class="px-4 py-3">${turno.hora}</td>
                <td class="px-4 py-3">${turno.motivo}</td>
                <td class="px-4 py-3">
                    <a href="tel:${paciente.telefono}" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-phone-alt mr-1"></i>${paciente.telefono}
                    </a>
                </td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 text-xs rounded-full ${getEstadoClase(turno.estado)}">
                        ${turno.estado}
                    </span>
                </td>
                <td class="px-4 py-3 space-x-2">
                    ${turno.estado === 'pendiente' ? `
                        <button onclick="cambiarEstado(${turno.id}, 'confirmado')" 
                            class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                            <i class="fas fa-check mr-1"></i>Confirmar
                        </button>
                        <button onclick="cambiarEstado(${turno.id}, 'cancelado')" 
                            class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                            <i class="fas fa-times mr-1"></i>Cancelar
                        </button>
                    ` : ''}
                    <button onclick="verHistorial(${paciente.id})" 
                        class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                        <i class="fas fa-history mr-1"></i>Historial
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function getEstadoClase(estado) {
        switch(estado) {
            case 'pendiente':
                return 'bg-yellow-100 text-yellow-800';
            case 'confirmado':
                return 'bg-green-100 text-green-800';
            case 'cancelado':
                return 'bg-red-100 text-red-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }

    function cambiarEstado(turnoId, nuevoEstado) {
        if (actualizarEstadoTurno(turnoId, nuevoEstado)) {
            actualizarTablaTurnos();
        }
    }

    function actualizarListaPacientes() {
        const grid = document.getElementById('pacientesGrid');
        grid.innerHTML = '';

        dbPacientes.forEach(paciente => {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow p-4';
            div.innerHTML = `
                <div class="flex items-center mb-3">
                    <img class="h-12 w-12 rounded-full mr-3" 
                        src="https://ui-avatars.com/api/?name=${encodeURIComponent(paciente.nombre)}" 
                        alt="${paciente.nombre}">
                    <div>
                        <h4 class="font-medium">${paciente.nombre}</h4>
                        <p class="text-sm text-gray-500">DNI: ${paciente.dni}</p>
                    </div>
                </div>
                <div class="space-y-2">
                    <p class="text-sm">
                        <i class="fas fa-phone-alt text-gray-400 mr-2"></i>${paciente.telefono}
                    </p>
                    <p class="text-sm">
                        <i class="fas fa-envelope text-gray-400 mr-2"></i>${paciente.email}
                    </p>
                    ${paciente.obraSocial ? `
                    <p class="text-sm">
                        <i class="fas fa-hospital text-gray-400 mr-2"></i>${paciente.obraSocial.nombre} - Plan ${paciente.obraSocial.plan}
                        <br>
                        <span class="ml-6 text-gray-500">N° Socio: ${paciente.obraSocial.numeroSocio}</span>
                    </p>
                    ` : ''}
                </div>
                <div class="mt-4 flex justify-end space-x-2">
                    <button onclick="verHistorial(${paciente.id})" 
                        class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                        <i class="fas fa-history mr-1"></i>Historial
                    </button>
                    <button onclick="editarPaciente(${paciente.id})" 
                        class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600">
                        <i class="fas fa-edit mr-1"></i>Editar
                    </button>
                    <button onclick="mostrarModalNuevoTurno(${paciente.id})" 
                        class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                        <i class="fas fa-calendar-plus mr-1"></i>Nuevo turno
                    </button>
                </div>
            `;
            grid.appendChild(div);
        });
    }

    function buscarPacientes() {
        const busqueda = document.getElementById('buscarPaciente').value.toLowerCase();
        const grid = document.getElementById('pacientesGrid');
        const tarjetas = grid.children;

        Array.from(tarjetas).forEach(tarjeta => {
            const nombre = tarjeta.querySelector('h4').textContent.toLowerCase();
            const dni = tarjeta.querySelector('.text-gray-500').textContent.toLowerCase();
            if (nombre.includes(busqueda) || dni.includes(busqueda)) {
                tarjeta.style.display = '';
            } else {
                tarjeta.style.display = 'none';
            }
        });
    }

    function mostrarModalNuevoTurno(pacienteId = null) {
        document.getElementById('modalNuevoTurno').classList.remove('hidden');
        if (pacienteId) {
            document.getElementById('pacienteSelect').value = pacienteId;
        }
    }

    function cerrarModalNuevoTurno() {
        document.getElementById('modalNuevoTurno').classList.add('hidden');
        document.getElementById('formNuevoTurno').reset();
    }

    function mostrarModalNuevoPaciente() {
        document.getElementById('modalNuevoPaciente').classList.remove('hidden');
    }

    function cerrarModalNuevoPaciente() {
        document.getElementById('modalNuevoPaciente').classList.add('hidden');
        document.getElementById('formNuevoPaciente').reset();
    }

    function mostrarModalHistorial() {
        document.getElementById('modalHistorial').classList.remove('hidden');
    }

    function cerrarModalHistorial() {
        document.getElementById('modalHistorial').classList.add('hidden');
    }

    function guardarNuevoTurno(event) {
        event.preventDefault();
        const turno = {
            pacienteId: parseInt(document.getElementById('pacienteSelect').value),
            fecha: document.getElementById('fechaTurno').value,
            hora: document.getElementById('horaTurno').value,
            motivo: document.getElementById('motivoTurno').value,
            estado: 'pendiente'
        };
        
        agregarTurno(turno);
        actualizarTablaTurnos();
        cerrarModalNuevoTurno();
    }

    function guardarNuevoPaciente(event) {
        event.preventDefault();
        const obraSocial = document.getElementById('obraSocialPaciente').value;
        const plan = document.getElementById('planObraSocial').value;
        const numeroSocio = document.getElementById('numeroSocio').value;

        const paciente = {
            nombre: document.getElementById('nombrePaciente').value,
            dni: document.getElementById('dniPaciente').value,
            telefono: document.getElementById('telefonoPaciente').value,
            email: document.getElementById('emailPaciente').value,
            obraSocial: obraSocial ? {
                nombre: obraSocial,
                plan: plan,
                numeroSocio: numeroSocio
            } : null
        };
        
        agregarPaciente(paciente);
        actualizarListaPacientes();
        cargarSelectPacientes();
        cerrarModalNuevoPaciente();
    }

    function cargarSelectPacientes() {
        const select = document.getElementById('pacienteSelect');
        select.innerHTML = '<option value="">Seleccionar paciente...</option>';
        
        dbPacientes.forEach(paciente => {
            const option = document.createElement('option');
            option.value = paciente.id;
            option.textContent = `${paciente.nombre} - DNI: ${paciente.dni}`;
            select.appendChild(option);
        });
    }

    function verHistorial(pacienteId) {
        const paciente = getPaciente(pacienteId);
        const historial = getHistorialPaciente(pacienteId);
        const turnos = getTurnosPaciente(pacienteId);
        
        const content = document.getElementById('historialContent');
        content.innerHTML = `
            <div class="mb-4">
                <h4 class="font-medium text-lg">${paciente.nombre}</h4>
                <p class="text-gray-500">DNI: ${paciente.dni}</p>
            </div>
            <div class="space-y-4">
                <div>
                    <h5 class="font-medium mb-2">Historial Médico</h5>
                    ${historial.length > 0 ? historial.map(h => `
                        <div class="bg-gray-50 p-3 rounded mb-2">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">${h.fecha}</span>
                                <span class="text-sm font-medium">${h.motivo}</span>
                            </div>
                            <p class="mt-1">${h.diagnostico}</p>
                            ${h.receta ? `<p class="text-sm text-gray-600 mt-1">Receta: ${h.receta}</p>` : ''}
                        </div>
                    `).join('') : '<p class="text-gray-500">No hay registros médicos</p>'}
                </div>
                <div>
                    <h5 class="font-medium mb-2">Historial de Turnos</h5>
                    ${turnos.length > 0 ? turnos.map(t => `
                        <div class="bg-gray-50 p-3 rounded mb-2">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-500">${t.fecha} ${t.hora}</span>
                                <span class="px-2 py-1 text-xs rounded-full ${getEstadoClase(t.estado)}">
                                    ${t.estado}
                                </span>
                            </div>
                            <p class="mt-1">${t.motivo}</p>
                        </div>
                    `).join('') : '<p class="text-gray-500">No hay turnos registrados</p>'}
                </div>
            </div>
        `;
        
        mostrarModalHistorial();
    }

    function cargarObrasSociales() {
        const select = document.getElementById('obraSocialPaciente');
        select.innerHTML = '<option value="">Sin obra social</option>';
        
        getObrasSociales().forEach(os => {
            const option = document.createElement('option');
            option.value = os.nombre;
            option.textContent = os.nombre;
            select.appendChild(option);
        });
    }

    function actualizarPlanes() {
        const obraSocial = document.getElementById('obraSocialPaciente').value;
        const planContainer = document.getElementById('planContainer');
        const numeroSocioContainer = document.getElementById('numeroSocioContainer');
        const planSelect = document.getElementById('planObraSocial');
        
        if (obraSocial) {
            const planes = getPlanesObraSocial(obraSocial);
            planSelect.innerHTML = '<option value="">Seleccionar plan...</option>';
            planes.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan;
                option.textContent = `Plan ${plan}`;
                planSelect.appendChild(option);
            });
            
            planContainer.classList.remove('hidden');
            numeroSocioContainer.classList.remove('hidden');
        } else {
            planContainer.classList.add('hidden');
            numeroSocioContainer.classList.add('hidden');
        }
    }

    function logout() {
        localStorage.removeItem('auth');
        localStorage.removeItem('remember');
        localStorage.removeItem('adminName');
        window.location.href = 'admin-login.html';
    }

    function actualizarDashboard() {
        const analisis = getAnalisisAvanzado();
        const ultimosMeses = obtenerUltimosMeses(6);
        
        document.getElementById('tasaOcupacion').textContent = 
            `${analisis.rendimiento.tasaOcupacion.porcentajeOcupacion}%`;
        document.getElementById('eficienciaTotal').textContent = 
            `${analisis.rendimiento.eficienciaAgenda.eficienciaTotal}%`;
        document.getElementById('tiempoEspera').textContent = 
            `${analisis.rendimiento.tiemposEspera.promedio} días`;
        document.getElementById('tasaCancelacion').textContent = 
            `${analisis.rendimiento.eficienciaAgenda.tasaCancelacion}%`;

        const ctxCrecimiento = document.getElementById('graficoCrecimiento').getContext('2d');
        new Chart(ctxCrecimiento, {
            type: 'line',
            data: {
                labels: ultimosMeses.map(m => m.mes),
                datasets: [{
                    label: 'Nuevos Pacientes',
                    data: ultimosMeses.map(m => calcularFrecuenciaVisitasPorPerfil()[m.mes]?.nuevos || 0),
                    borderColor: 'rgb(59, 130, 246)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        const ctxDistribucion = document.getElementById('graficoDistribucion').getContext('2d');
        const distribucionData = analisis.rendimiento.distribucionCarga.distribucionHoraria;
        new Chart(ctxDistribucion, {
            type: 'bar',
            data: {
                labels: Object.keys(distribucionData),
                datasets: [{
                    label: 'Turnos por Hora',
                    data: Object.values(distribucionData),
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        const ctxObrasSociales = document.getElementById('graficoObrasSociales').getContext('2d');
        const distribucionOS = calcularDistribucionOSPorMes(ultimosMeses[0]);
        new Chart(ctxObrasSociales, {
            type: 'pie',
            data: {
                labels: Object.keys(distribucionOS),
                datasets: [{
                    data: Object.values(distribucionOS),
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(139, 92, 246, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });

        const ctxPredicciones = document.getElementById('graficoPredicciones').getContext('2d');
        const prediccionData = analisis.tendencias.prediccionDemanda;
        new Chart(ctxPredicciones, {
            type: 'line',
            data: {
                labels: prediccionData.map(p => p.periodo),
                datasets: [{
                    label: 'Demanda Prevista',
                    data: prediccionData.map(p => p.demandaPrevista),
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        const recomendacionesContainer = document.getElementById('recomendaciones');
        recomendacionesContainer.innerHTML = '';
        
        const turnosHoy = turnos.filter(t => t.fecha === new Date().toISOString().split('T')[0]);
        const probCancelacion = calcularProbabilidadCancelacion(turnosHoy);
        
        const recomendaciones = [
            `Probabilidad de cancelación para hoy: ${probCancelacion}%`,
            ...analisis.rendimiento.distribucionCarga.recomendaciones
        ];

        recomendaciones.forEach(rec => {
            const div = document.createElement('div');
            div.className = 'flex items-center text-blue-700 mb-2';
            div.innerHTML = `
                <i class="fas fa-info-circle mr-2"></i>
                <span>${rec}</span>
            `;
            recomendacionesContainer.appendChild(div);
        });
    }

    function editarPaciente(pacienteId) {
        const paciente = getPaciente(pacienteId);
        if (!paciente) return;

        document.getElementById('editPacienteId').value = paciente.id;
        document.getElementById('editNombrePaciente').value = paciente.nombre;
        document.getElementById('editDniPaciente').value = paciente.dni;
        document.getElementById('editTelefonoPaciente').value = paciente.telefono;
        document.getElementById('editEmailPaciente').value = paciente.email;
        
        const selectOS = document.getElementById('editObraSocialPaciente');
        selectOS.innerHTML = '<option value="">Sin obra social</option>';
        getObrasSociales().forEach(os => {
            const option = document.createElement('option');
            option.value = os.nombre;
            option.textContent = os.nombre;
            selectOS.appendChild(option);
        });

        if (paciente.obraSocial) {
            selectOS.value = paciente.obraSocial.nombre;
            actualizarPlanesEdicion();
            setTimeout(() => {
                document.getElementById('editPlanObraSocial').value = paciente.obraSocial.plan;
                document.getElementById('editNumeroSocio').value = paciente.obraSocial.numeroSocio;
            }, 100);
        }

        document.getElementById('modalEditarPaciente').classList.remove('hidden');
    }

    function actualizarPlanesEdicion() {
        const obraSocial = document.getElementById('editObraSocialPaciente').value;
        const planContainer = document.getElementById('editPlanContainer');
        const numeroSocioContainer = document.getElementById('editNumeroSocioContainer');
        const planSelect = document.getElementById('editPlanObraSocial');
        
        if (obraSocial) {
            const planes = getPlanesObraSocial(obraSocial);
            planSelect.innerHTML = '<option value="">Seleccionar plan...</option>';
            planes.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan;
                option.textContent = `Plan ${plan}`;
                planSelect.appendChild(option);
            });
            
            planContainer.classList.remove('hidden');
            numeroSocioContainer.classList.remove('hidden');
        } else {
            planContainer.classList.add('hidden');
            numeroSocioContainer.classList.add('hidden');
        }
    }

    function cerrarModalEditarPaciente() {
        document.getElementById('modalEditarPaciente').classList.add('hidden');
        document.getElementById('formEditarPaciente').reset();
    }

    function guardarEdicionPaciente(event) {
        event.preventDefault();
        const pacienteId = parseInt(document.getElementById('editPacienteId').value);
        const obraSocial = document.getElementById('editObraSocialPaciente').value;
        const plan = document.getElementById('editPlanObraSocial').value;
        const numeroSocio = document.getElementById('editNumeroSocio').value;

        const pacienteActualizado = {
            nombre: document.getElementById('editNombrePaciente').value,
            dni: document.getElementById('editDniPaciente').value,
            telefono: document.getElementById('editTelefonoPaciente').value,
            email: document.getElementById('editEmailPaciente').value,
            obraSocial: obraSocial ? {
                nombre: obraSocial,
                plan: plan,
                numeroSocio: numeroSocio
            } : null
        };
        
        actualizarPaciente(pacienteId, pacienteActualizado);
        actualizarListaPacientes();
        cerrarModalEditarPaciente();
    }
    </script>
</body>
</html> 